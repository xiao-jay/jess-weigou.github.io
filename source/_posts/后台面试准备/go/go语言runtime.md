---
title: go语言runtime
---



go语言goroutine用的是协程

#### go runtime中的GC（garbage collection）过程

用三色标记法和写屏障减少STW（stop the world）的时间

##### 三色标记法

- 开始事件都标记成白色，从root开始扫描，扫描到的时候标记成灰色，放入到待处理队列里面

- 遍历灰色对象队列，将其引用的对象标记成灰色，自身标记成黑色

- 这样重复遍历，直到待处理队列中无灰色事件，最后将白色事件回收

##### 写屏障

标记与程序的并发执行的，会出现一个问题，已经标记为黑色的事件还是会引出对象，这时候这个被引出的对象是白色，因为黑色已经被标记不会被扫描，这个黑色事件引出的白色事件不会被扫描，最后被删掉，为了解决这个问题加入写屏障，约定在清扫开始前的时候黑色的事件不可以引出对象

##### GC触发条件

1、内存分配到一定比例

2、2分钟内没触发过GC，就触发GC

3、手动触发，调用runtime.GC