---
title: DNS解析
excerpt: 所在模块：计算机网络
tags: [计算机网络]
categories: 后端面试
banner_img: /img/壁纸.jpg
---

### 域名(Domain)

```bash
mail.ccav.com
---- ---- ----
三级域名 二级域名 顶级域名
```

域名的层级是按照上面这么划分的，每级域名长度不超过63个字符，不区分大小写，只能使用数字字母和-。一个完整的域名不超过255个字符。

## 域名服务器划分

了解域名服务器划分之后，就会对DNS解析的过程大概有些了解。域名服务器按照层级分为：

![](https://tva1.sinaimg.cn/large/e6c9d24ely1h0g3n3117yj20kb08dmxy.jpg)

### 本地域名服务器

本地域名服务器相当于一个班主任，你有点啥事都找他。当一个主机发出DNS查询的时候，这个查询的请求就会发送到本地域名服务器。

### 根域名服务器

根域名服务器是最高层次的域名服务，是校长,只负责规划大方向。他知道所有顶级域名服务器的域名和IP地址。不管那个本地域名服务器若自己不能不能解析，那首先请求的就是根域名服务器。根域名服务器不会把待查询的域名直接转换成IP，而是告诉本地域名服务器下一步应该找哪一个顶级域名服务器进行查询。

### 顶级域名服务器

顶级域名服务器是负责各个方向的副校长，有负责安全的，有负责教学的。他负责管理该顶级域名下的所有二级域名，当收到DNS查询请求后就会给出响应的应答，可能是最终的结果，也可能是下一步应该找到的域名服务器的IP地址。

### 权限域名服务器

权限域名服务器就是负责一个区的域名服务器，是基层干活的，比如宿管，各科老师，他负责一个更小的区域。当一个权限服务还不能给出最后的回答时，就会告诉查询请求的DNS客户，下一步应该找哪个权限域名服务器。

## 域名查询的两种方式

### 递归查询

递归查询，就是你找我要一个域名的IP地址，但是我不知道，那我去帮你去向知道的人问这个IP地址。举个例子就是，你问你班主任怎么做番茄炒鸡蛋，你班主任不知道，但是你班主任去问了食堂厨师，然后告诉你。这就叫递归查询。
从host到本地域名服务器一般是用的递归查询。

### 迭代查询

迭代查询就是，你找我要一个域名的IP地址，我也不知道这个IP地址，但是我知道谁知道，我告诉你去找谁问。举个例子就是，你们班主任到了食堂随便拉了个人问怎么做番茄炒鸡蛋，那个人说，我只是个卖饭的，我不知道，但是我知道A君是在后厨的，你可以去问A君。然后你班主任就去问A君了。呐，这就叫迭代查询。
从本地域名服务器到根域名服务器一般是用的迭代查询。

行了，该知道的储备知识我们知道的差不多了，接下来就看看关键的流程吧。

#### dns解析默认是什么方式查询

主机向本地域名服务器的查询一般都是采用递归查询。

本地域名服务器向根域名服务器的查询的迭代查询。

# DNS查询步骤

假设一台主机想知道y.abc.com这个域名的IP地址，那么整个的查询过程如下：

1. 主机先向其本地域名服务器进行递归查询
2. 本地域名服务器采用迭代的查询，它先向根域名服务器查询
3. 根域名服务器告诉本地域名服务器，下一次应该查询的顶级域名服务器的IP地址。
4. 本地域名服务器向顶级域名服务器发起查询。
5. 顶级域名服务器告诉本地域名服务器，下一次应查询的权限域名服务器IP地址
6. 本地域名服务器向权限域名服务器发起查询。
7. 权限域名服务器告诉本地域名服务器所查询的IP地址。
8. 本地域名服务器把查询结果告诉主机



#### 为什么DNS要放到应用层

因为DNS是基于UDP协议的服务，所以把他放到传输层上一层。

#### 为什么DNS要使用UDP

DNS 查询的场景中我们其实并不需要稳定的连接（或者以为不需要），每一次 DNS 查询都会直接向命名服务器发送 UDP 数据报，与此同时常见 DNS 查询的数据包都非常小，TCP 建立连接会带来以下的额外开销：

假设网络通信所消耗的时间是可以忽略的不计的，如果我们只考虑 TCP 建立连接时传输的数据的话，可以简单来算一笔账：

- 使用 TCP 协议（共 330 字节）
  - 三次握手 — 14x3(Ethernet) + 20x3(IP) + 44 + 44 + 32(TCP) 字节
  - 查询协议头 — 14(Ethernet) + 20(IP) + 20(TCP) 字节
  - 响应协议头 — 14(Ethernet) + 20(IP) + 20(TCP) 字节
- 使用 UDP 协议（共 84 字节）
  - 查询协议头 — 14(Ethernet) + 20(IP) + 8(UDP) 字节
  - 响应协议头 — 14(Ethernet) + 20(IP) + 8(UDP) 字节

> 注1：TCP 首部的开销与具体的请求和环境有关，具体结果可能有小幅波动，其大小约为 120 字节。

注2：我们在这里计算结果的前提是 DNS 解析器**只需要与一个命名服务器或者权威服务器进行通信**就可以获得 DNS 响应，但是在实际场景中，DNS 解析器可能会递归地与多个命名服务器进行通信，这也加倍地放大了 TCP 协议在额外开销上的劣势。

从理论上来说，一个 UDP 数据包的大小最多可以达到 64KB，这对于一个常见的 DNS 查询其实是一个非常大的数值；但是在实际生产中，一旦数据包中的数据超过了传送链路的最大传输单元（MTU，也就是单个数据包大小的上限，一般为 1500 字节），当前数据包就可能会被分片传输、丢弃，部分的网络设备甚至会直接拒绝处理包含 EDNS(0) 选项的请求，这就会导致使用 UDP 协议的 DNS 不稳定。

TCP 作为可靠的传输协议，可以非常好的解决这个问题，通过序列号、重传等机制能够保证消息的不重不漏，消息接受方的 TCP 栈会对分片的数据重新进行拼装，DNS 等应用层协议可以直接使用处理好的完整数据。同时，当数据包足够大的时候，TCP 三次握手带来的额外开销比例就会越来越小，与整个包的大小相比就会趋近于 0：

- 当 DNS 数据包大小为 500 字节时，TCP 协议的额外开销为 ~41.2%；
- 当 DNS 数据包大小为 1100 字节时，TCP 协议的额外开销为 ~20.7%；
- 当 DNS 数据包大小为 2300 字节时，TCP 协议的额外开销为 ~10.3%；
- 当 DNS 数据包大小为 4800 字节时，TCP 协议的额外开销为 ~5.0%；

![tcp-udp-cost](https://img.draveness.me/tcp-udp-cost.png)

所以，我们在 DNS 中存储较多的内容时，TCP 三次握手以及协议头带来的额外开销就不是关键因素了，不过我们 TCP 三次握手带来的三次网络传输耗时还是没有办法避免的，这也是我们在目前的场景下不得不接受的问题。

## 总结

很多人认为 DNS 使用了 UDP 协议来获取域名对应的 IP 地址，这个观点虽然没错，但是还是有一些片面，更加准确的说法其实是 DNS **查询**在刚设计时主要使用 UDP 协议进行通信，而 TCP 协议也是在 DNS 的演进和发展中被加入到规范的：

1. DNS 在设计之初就在区域传输中引入了 TCP 协议，在查询中使用 UDP 协议；
2. 当 DNS 超过了 512 字节的限制，我们第一次在 DNS 协议中明确了『当 DNS 查询被截断时，应该使用 TCP 协议进行重试』这一规范；
3. 随后引入的 EDNS 机制允许我们使用 UDP 最多传输 4096 字节的数据，但是由于 MTU 的限制导致的数据分片以及丢失，使得这一特性不够可靠；
4. 在最近的几年，我们重新规定了 DNS 应该同时支持 UDP 和 TCP 协议，TCP 协议也不再只是重试时的选择；





参考文章：https://draveness.me/whys-the-design-dns-udp-tcp/
