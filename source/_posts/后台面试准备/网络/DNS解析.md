

### 域名(Domain)

```bash
mail.ccav.com
---- ---- ----
三级域名 二级域名 顶级域名
```

域名的层级是按照上面这么划分的，每级域名长度不超过63个字符，不区分大小写，只能使用数字字母和-。一个完整的域名不超过255个字符。

## 域名服务器划分

了解域名服务器划分之后，就会对DNS解析的过程大概有些了解。域名服务器按照层级分为：

![](https://tva1.sinaimg.cn/large/e6c9d24ely1h0g3n3117yj20kb08dmxy.jpg)

### 本地域名服务器

本地域名服务器相当于一个班主任，你有点啥事都找他。当一个主机发出DNS查询的时候，这个查询的请求就会发送到本地域名服务器。

### 根域名服务器

根域名服务器是最高层次的域名服务，是校长,只负责规划大方向。他知道所有顶级域名服务器的域名和IP地址。不管那个本地域名服务器若自己不能不能解析，那首先请求的就是根域名服务器。根域名服务器不会把待查询的域名直接转换成IP，而是告诉本地域名服务器下一步应该找哪一个顶级域名服务器进行查询。

### 顶级域名服务器

顶级域名服务器是负责各个方向的副校长，有负责安全的，有负责教学的。他负责管理该顶级域名下的所有二级域名，当收到DNS查询请求后就会给出响应的应答，可能是最终的结果，也可能是下一步应该找到的域名服务器的IP地址。

### 权限域名服务器

权限域名服务器就是负责一个区的域名服务器，是基层干活的，比如宿管，各科老师，他负责一个更小的区域。当一个权限服务还不能给出最后的回答时，就会告诉查询请求的DNS客户，下一步应该找哪个权限域名服务器。

## 域名查询的两种方式

### 递归查询

递归查询，就是你找我要一个域名的IP地址，但是我不知道，那我去帮你去向知道的人问这个IP地址。举个例子就是，你问你班主任怎么做番茄炒鸡蛋，你班主任不知道，但是你班主任去问了食堂厨师，然后告诉你。这就叫递归查询。
从host到本地域名服务器一般是用的递归查询。

### 迭代查询

迭代查询就是，你找我要一个域名的IP地址，我也不知道这个IP地址，但是我知道谁知道，我告诉你去找谁问。举个例子就是，你们班主任到了食堂随便拉了个人问怎么做番茄炒鸡蛋，那个人说，我只是个卖饭的，我不知道，但是我知道A君是在后厨的，你可以去问A君。然后你班主任就去问A君了。呐，这就叫迭代查询。
从本地域名服务器到根域名服务器一般是用的迭代查询。

行了，该知道的储备知识我们知道的差不多了，接下来就看看关键的流程吧。

#### dns解析默认是什么方式查询

主机向本地域名服务器的查询一般都是采用递归查询。

本地域名服务器向根域名服务器的查询的迭代查询。

# DNS查询步骤

假设一台主机想知道y.abc.com这个域名的IP地址，那么整个的查询过程如下：

1. 主机先向其本地域名服务器进行递归查询
2. 本地域名服务器采用迭代的查询，它先向根域名服务器查询
3. 根域名服务器告诉本地域名服务器，下一次应该查询的顶级域名服务器的IP地址。
4. 本地域名服务器向顶级域名服务器发起查询。
5. 顶级域名服务器告诉本地域名服务器，下一次应查询的权限域名服务器IP地址
6. 本地域名服务器向权限域名服务器发起查询。
7. 权限域名服务器告诉本地域名服务器所查询的IP地址。
8. 本地域名服务器把查询结果告诉主机



#### 为什么DNS要放到应用层

因为DNS是基于UDP协议的服务，所以把他放到传输层上一层。

#### 为什么DNS要使用UDP

DNS 查询的场景中我们其实并不需要稳定的连接（或者以为不需要），每一次 DNS 查询都会直接向命名服务器发送 UDP 数据报，与此同时常见 DNS 查询的数据包都非常小，TCP 建立连接会带来以下的额外开销：

假设网络通信所消耗的时间是可以忽略的不计的，如果我们只考虑 TCP 建立连接时传输的数据的话，可以简单来算一笔账：

- 使用 TCP 协议（共 330 字节）
  - 三次握手 — 14x3(Ethernet) + 20x3(IP) + 44 + 44 + 32(TCP) 字节
  - 查询协议头 — 14(Ethernet) + 20(IP) + 20(TCP) 字节
  - 响应协议头 — 14(Ethernet) + 20(IP) + 20(TCP) 字节
- 使用 UDP 协议（共 84 字节）
  - 查询协议头 — 14(Ethernet) + 20(IP) + 8(UDP) 字节
  - 响应协议头 — 14(Ethernet) + 20(IP) + 8(UDP) 字节

> 注1：TCP 首部的开销与具体的请求和环境有关，具体结果可能有小幅波动，其大小约为 120 字节。

注2：我们在这里计算结果的前提是 DNS 解析器**只需要与一个命名服务器或者权威服务器进行通信**就可以获得 DNS 响应，但是在实际场景中，DNS 解析器可能会递归地与多个命名服务器进行通信，这也加倍地放大了 TCP 协议在额外开销上的劣势。

从理论上来说，一个 UDP 数据包的大小最多可以达到 64KB，这对于一个常见的 DNS 查询其实是一个非常大的数值；但是在实际生产中，一旦数据包中的数据超过了传送链路的最大传输单元（MTU，也就是单个数据包大小的上限，一般为 1500 字节），当前数据包就可能会被分片传输、丢弃，部分的网络设备甚至会直接拒绝处理包含 EDNS(0) 选项的请求，这就会导致使用 UDP 协议的 DNS 不稳定。

TCP 作为可靠的传输协议，可以非常好的解决这个问题，通过序列号、重传等机制能够保证消息的不重不漏，消息接受方的 TCP 栈会对分片的数据重新进行拼装，DNS 等应用层协议可以直接使用处理好的完整数据。同时，当数据包足够大的时候，TCP 三次握手带来的额外开销比例就会越来越小，与整个包的大小相比就会趋近于 0：

- 当 DNS 数据包大小为 500 字节时，TCP 协议的额外开销为 ~41.2%；
- 当 DNS 数据包大小为 1100 字节时，TCP 协议的额外开销为 ~20.7%；
- 当 DNS 数据包大小为 2300 字节时，TCP 协议的额外开销为 ~10.3%；
- 当 DNS 数据包大小为 4800 字节时，TCP 协议的额外开销为 ~5.0%；

![tcp-udp-cost](https://img.draveness.me/tcp-udp-cost.png)

所以，我们在 DNS 中存储较多的内容时，TCP 三次握手以及协议头带来的额外开销就不是关键因素了，不过我们 TCP 三次握手带来的三次网络传输耗时还是没有办法避免的，这也是我们在目前的场景下不得不接受的问题。

## 总结

很多人认为 DNS 使用了 UDP 协议来获取域名对应的 IP 地址，这个观点虽然没错，但是还是有一些片面，更加准确的说法其实是 DNS **查询**在刚设计时主要使用 UDP 协议进行通信，而 TCP 协议也是在 DNS 的演进和发展中被加入到规范的：

1. DNS 在设计之初就在区域传输中引入了 TCP 协议，在查询中使用 UDP 协议；
2. 当 DNS 超过了 512 字节的限制，我们第一次在 DNS 协议中明确了『当 DNS 查询被截断时，应该使用 TCP 协议进行重试』这一规范；
3. 随后引入的 EDNS 机制允许我们使用 UDP 最多传输 4096 字节的数据，但是由于 MTU 的限制导致的数据分片以及丢失，使得这一特性不够可靠；
4. 在最近的几年，我们重新规定了 DNS 应该同时支持 UDP 和 TCP 协议，TCP 协议也不再只是重试时的选择；



### DNS域名解析中添加的各项解析记录

**A记录**： 将域名指向一个IPv4地址（例如：100.100.100.100），需要增加A记录

**CNAME记录**： 如果将域名指向一个域名，实现与被指向域名相同的访问效果，需要增加CNAME记录。这个域名一般是主机服务商提供的一个域名

**MX记录**： 建立电子邮箱服务，将指向邮件服务器地址，需要设置MX记录。建立邮箱时，一般会根据邮箱服务商提供的MX记录填写此记录

**NS记录**： 域名解析服务器记录，如果要将子域名指定某个域名服务器来解析，需要设置NS记录

**TXT记录**： 可任意填写，可为空。一般做一些验证记录时会使用此项，如：做SPF（反垃圾邮件）记录

**AAAA记录**： 将主机名（或域名）指向一个IPv6地址（例如：ff03:0:0:0:0:0:0:c1），需要添加AAAA记录

**SRV记录**： 添加服务记录服务器服务记录时会添加此项，SRV记录了哪台计算机提供了哪个服务。格式为：服务的名字.协议的类型（例如：_example-server._tcp）。

**SOA记录**： SOA叫做起始授权机构记录，NS用于标识多台域名解析服务器，SOA记录用于在众多NS记录中那一台是主服务器

**PTR记录**： PTR记录是A记录的逆向记录，又称做IP反查记录或指针记录，负责将IP反向解析为域名

**显性URL转发记录**： 将域名指向一个`http(s)`协议地址，访问域名时，自动跳转至目标地址。例如：将www.liuht.cn显性转发到www.itbilu.com后，访问www.liuht.cn时，地址栏显示的地址为：www.itbilu.com。

**隐性UR转发记录L**： 将域名指向一个`http(s)`协议地址，访问域名时，自动跳转至目标地址，隐性转发会隐藏真实的目标地址。例如：将www.liuht.cn显性转发到www.itbilu.com后，访问www.liuht.cn时，地址栏显示的地址仍然是：www.liuht.cn。

参考文章：https://draveness.me/whys-the-design-dns-udp-tcp/





## 什么是根域名服务器

全球共有13台根域名服务器。这13台根域名服务器中名字分别为“A”至“M”，其中10台设置在美国，另外各有一台设置于英国、瑞典和日本。。其余12个均为辅根服务器，其中9个放置在美国，欧洲2个，位于英国和瑞典，亚洲1个，位于日本。所有根服务器均由美国政府授权的互联网域名与号码分配机构ICANN统一管理，负责全球互联网域名根服务器、域名体系和IP地址等的管理。这13台根服务器可以指挥Firefox或InternetExplorer这样的Web浏览器和电子邮件程序控制互联网通信。由于根服务器中有经美国政府批准的260个左右的互联网后缀（如．com、．net等）和一些国家的指定符（如法国的．fr、挪威的．no等），自成立以来，美国政府每年花费近50多亿美元用于根服务器的维护和运行，承担了世界上最繁重的网络任务和最巨大的网络风险。因此可以实事求是地说：没有美国，互联网将是死灰一片。世界对美国互联网的依赖性非常大，当然这也主要是由其技术的先进性和管理的科学性所决定的。所谓依赖性，从国际互联网的工作机理来体现的，就在于“根服务器”的问题。从理论上说，任何形式的标准域名要想被实现解析，按照技术流程，都必须经过全球“层级式”域名解析体系的工作，才能完成。

“层级式”域名解析体系第一层就是根服务器，负责管理世界各国的域名信息，在根服务器下面是顶级域名服务器，即相关国家域名管理机构的数据库，如中国的CNNIC，然后是在下一级的域名数据库和ISP的缓存服务器。一个域名必须首先经过根数据库的解析后，才能转到顶级域名服务器进行解析。





### 怎么样找到本地域名服务器

它会首先迁移到您的 ISP 的 DNS 服务器。



## 什么是 DNS 根服务器？

[域名系统 (DNS) ](https://www.cloudflare.com/learning/dns/what-is-dns/)的管理通过使用不同的受管理分区或[“区域”](https://www.cloudflare.com/learning/dns/glossary/dns-zone)的层次结构构造，其根区域位于该层次结构的最顶部。根服务器是在根区域中运行的 DNS 域名服务器。这些服务器可以直接回答针对根区域内存储或缓存的记录的查询，还可以将其他请求引向相应的[顶级域 (TLD) 服务器](https://www.cloudflare.com/learning/dns/dns-server-types#tld-nameserver)。TLD 服务器是 DNS 层次结构中比根服务器低一级的 DNS 服务器组，它们是解析 DNS 查询的必要部分。

![DNS 层次结构](https://www.cloudflare.com/img/learning/dns/glossary/dns-root-server/dns-root-server.png)

在未缓存的 DNS 查询期间，每当用户在浏览器中输入网址，该操作都会触发 DNS 查找，并且所有 DNS 查找都从根区域开始。查找到达根区域后，将沿 DNS 系统的层次结构向下移动，首先到达 TLD 服务器，然后到达特定域（可能还有子域）的服务器，直到最终到达[权威性名称服务器](https://www.cloudflare.com/learning/dns/dns-server-types#authoritative-nameserver)，以查到正确的域名，其中包含要搜索的网站的数字 [IP 地址](https://www.cloudflare.com/learning/dns/glossary/what-is-my-ip-address/)。然后，该 IP 地址被返回给客户端。有趣的是，尽管需要许多步骤，但此过程仍可以非常快速地进行。

根服务器是 Internet 基础设施的重要组成部分；没有它们，Web 浏览器和许多其他 Internet 工具将无法工作。有 13 个不同的 IP 地址为 DNS 根区域提供服务，并且全球有数百个冗余根服务器来处理对根区域的请求。

## 为什么只有 13 个 DNS 根服务器地址？

一个普遍的误解是，世界上只有 13 台根服务器。实际上根服务器有许多，但只有 13 个 IP 地址用于查询不同的根服务器网络。DNS 原始架构的限制要求根区域中最多只能有 13 个服务器地址。在 Internet 面世之初，这 13 个 IP 地址的每一个都只有一台服务器，其中大多数位于美国。

如今，这 13 个 IP 地址中的每一个都有多个服务器，这些服务器使用 [Anycast 路由](https://www.cloudflare.com/learning/cdn/glossary/anycast-network/)基于负荷和距离分发请求。目前，地球上每座有人生活的大陆上都分布着 600 多台 DNS 根服务器。

## 谁在操作 DNS 根服务器？

互联网名称和数字地址分配机构 (ICANN) 为根区域中 13 个 IP 地址之一操作服务器，并将其他 12 个 IP 地址的操作委托给包括 NASA、马里兰大学和 Verisign（唯一运营两个根 IP 地址的组织）在内的多个组织。Cloudflare 帮助向名为 F-Root 的根服务器提供 DNS Anycast 服务；Cloudflare 根据与 ISC（F-Root 运营商）的合同提供其他 F-Root 实例。[了解有关 Cloudflare 如何支持 F-Root 的更多信息。](https://blog.cloudflare.com/f-root/)

## 解析器如何找到 DNS 根服务器？

由于 DNS 根区域位于 DNS 层次结构的顶部，因此递归解析器无法在 DNS 查找中被引导到这些位置。因此，每个 DNS 解析器都在其软件中内置了 13 个 IP 根服务器地址的列表。每次发起 DNS 查找时，递归器的第一个通信就是与这 13 个 IP 地址之一进行的。
