---
title: 蓝绿部署、金丝雀部署的含义和区别
excerpt: 所在模块：部署思想
tags: [部署思想]
categories: 后端面试
banner_img: /img/壁纸.jpg
---

## 蓝绿部署、金丝雀部署的含义和区别

在一般情况下，升级服务器端应用，需要将应用源码或程序包上传到服务器，然后停止掉老版本服务，再启动新版本。但是这种简单的发布方式存在两个问题，一方面，在新版本升级过程中，服务是暂时中断的，另一方面，如果新版本有BUG，升级失败，回滚起来也非常麻烦，容易造成更长时间的服务不可用。**为了解决这些（服务中断、失败回滚、……）问题，人们研究出了多种发布策略。**

##### 1、蓝绿部署 – BlueGreenDeployment

> It’s basically a technique for *releasing your application in a predictable* manner with an goal of *reducing any downtime associated with a release*. It’s a quick way to prime your app before releasing, and also quickly roll back if you find issues.

**蓝绿部署的目的是——减少因发布导致的服务中断时间**，同时它也支持发布失败时的快速回滚。

![img](https://ixyzero.com/blog/wp-content/uploads/2020/01/blue_green_deployments.png)

蓝绿部署需要在发布过程中，同时运行两套程序。对硬件的要求也是当前所需的2倍，比如当前运行时，需要10台服务器支撑业务，那么使用蓝绿部署，你就需要购置20台服务器。

##### 2、滚动发布/更新

所谓滚动发布，就是在发布过程中，并不一下子启动所有新版本，而是先启动一台新版本，再停止一台老版本，然后再启动一台新版本，再停止一台老版本，直到全部发布完成，这样的话，如果当前需要10台服务器支撑服务，那么升级过程中一共只需要11台就行了。

**滚动发布能够解决掉蓝绿部署时对硬件要求增倍的问题。**

但是滚动发布有一个问题，在开始滚动发布后，流量会直接流向已经启动起来的新版本，但是这个时候，新版本是不一定稳定/符合预期的，可能需要进一步的测试才能确认。那么在滚动发布期间，整个系统就处于较为不稳定的状态，如果发现了问题，也比较难以确定是新版本还是老版本造成的问题。
为了解决这个问题，我们需要为滚动发布实现流量控制能力。也就是下面的金丝雀发布/灰度发布。

##### 2.1、金丝雀发布 –  (也叫灰度发布)

> 17世纪，英国矿井工人发现，金丝雀对瓦斯这种气体十分敏感。空气中哪怕有极其微量的瓦斯，金丝雀也会停止歌唱；而当瓦斯含量超过一定限度时，虽然人类毫无察觉，金丝雀却早已毒发身亡。当时在采矿设备相对简陋的条件下，工人们每次下井都会带上一只金丝雀作为“瓦斯检测指标”，以便在危险状况下紧急撤离。
>
> 金丝雀发布(Canary Releases)名称的由来

金丝雀发布指的是在生产环境中分阶段逐步更新后端应用的版本（需要具备流量控制能力），在小范围验证符合预期之后，再推广至整个生产环境。

![img](https://ixyzero.com/blog/wp-content/uploads/2020/01/canary-release-2.png)

**金丝雀发布的好处在于可以用真实环境测试新版本**，当新版本存在问题时最多只影响部分用户，且支持安全快速的回滚策略（将路由到新版本上的流量切换到其它的老版本机器上即可）。

但金丝雀发布并不是完美的，如果新版本有问题，那么路由到新版本的小部分流量会有问题，就跟矿井中毒发身亡的金丝雀一样。这种做法在非常敏感的业务中几乎无法接受，但是当系统复杂的到一定程度，错误无法完全避免的时候，为了避免出现更大的问题，牺牲一小部分流量，就可以将大部分错误的影响控制在一定范围内。

------

##### A/B测试 – A/B Testing

**首先需要明确的是，A/B测试和蓝绿部署以及金丝雀发布，完全是不同类型的概念。**

蓝绿部署和金丝雀发布是发布策略，目标是确保新上线的系统稳定，关注的是新系统的BUG、隐患。

**A/B测试是效果测试（一般用来验证某个想法是否符合预期）**，同一时间有多个版本的服务对外服务，这些服务都是经过足够测试，达到了上线标准的服务，有差异但是没有新旧之分。它关注的是不同版本的服务的实际效果，譬如说转化率、订单情况等。

A/B测试时，线上同时运行多个版本的服务，这些服务通常会有一些体验上的差异，譬如说页面样式、颜色、操作流程不同。相关人员通过分析各个版本服务的实际效果，以选出效果最好的版本。

![img](https://ixyzero.com/blog/wp-content/uploads/2020/01/abtesting.png)



参考文章：https://ixyzero.com/blog/archives/4722.html
